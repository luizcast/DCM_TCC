---
title: "Dicom Detect with YOLOv7"
author: "Luiz Castiglioni"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  html_document: null
  toc: yes
  toc_depth: 2
  num_sections: yes
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo =TRUE)
```

```{r, warning=FALSE, echo=FALSE, include=FALSE}
library(magick)
```

```{r echo=FALSE}
magick::image_read('IMGs/test/X0003852776_2_69.png') %>% plot()
```

Trabalho de conclusão de curso do aluno Luiz Castiglioni.Pós-graduação MBA - Data Science and Analytics da USP / ESALQ. Trabalho desenvolvido em parceria com o departamento de AI da Escola Paulista de Medicina UNIFESP.

## Especificações do Projeto

### Data info

Tomographic images and Metadata of Medical Exams in DICOM Standards Format

-   total files: 165371
-   total size: 89.9GB
-   format: ".dcm"

### Links

-   Dicom Medicine Standards <https://www.dicomstandard.org/ai>
-   YOLO <https://pjreddie.com/darknet/yolo/>
-   Github <https://github.com/luizcast/DCM_TCC>

### Arquivos do projeto

```{r, include=TRUE}
list.files(include.dirs = TRUE)
```
### Configurações da Máquina

```{bash}
neofetch --stdout --disable theme wm theme icons packages uptime resolution de
```



### Configurações do RStudio
```{r}
#RStudio 2022.07.2+576 "Spotted Wakerobin" 
#Release 2022-09-06 for Ubuntu Bionic
version
```   


### Pacotes utilizados no projeto

-   oro.dicom - <https://cran.r-project.org/web/packages/oro.dicom/index.html>
-   dcmtk - <https://dicom.offis.de/dcmtk.php.en>
-   tidyverse - <https://www.tidyverse.org/>
-   tensorflow - <https://www.tensorflow.org/>
-   keras - <https://keras.io/>

```{r}
library("keras") 
library("tensorflow")
library("tidyverse")
library("oro.dicom")
library("dcmtk")
library("readxl")
```


## Reconhecendo Padrões em imagens de Tomografia de Abdómen no formato DICOM.

Foram selecionados 200 exames de tomografia de abdomen de 200 pacientes diferentes. Desses 200 exames foram geradas anotações pelo grupo de médicos e residentes da UNIFESP sobre a presença do órgão vesícula ou a presença do clipe cirúrgico em casos de pacientes que tiveram a vesícula retirada. Surgiram 4 classes:

-   Pacientes com Vesícula Normal

-   Pacientes com Vesícula Hipodistendida

-   Pacientes sem Vesícula e com Clipe Cirúrgico

-   Pacientes sem Vesícula e sem Clipe Cirúrgico

Destas anotações surgiu a tabela **annot_clean**

```{r}
read_excel("~/Desktop/USP/TCC/projeto_TCC/annot_clean.xlsx") %>% as_tibble() -> annot_clean
annot_clean
colnames(annot_clean)
```

### Tabela annot_Clean

```{r annot_clean, warning=FALSE}
gsub(pattern = "Não se aplica", replacement = "NA", 
     annot_clean$`Densidade não habitual (sim=1, não=0)`) ->
  annot_clean$`Densidade não habitual (sim=1, não=0)`
gsub(pattern = "Não se aplica", replacement = "NA", 
     annot_clean$`Corte INICIAL vesícula`) -> 
  annot_clean$`Corte INICIAL vesícula`
gsub(pattern = "Não se aplica", replacement = "NA", 
     annot_clean$`Corte FINAL vesícula`) -> 
  annot_clean$`Corte FINAL vesícula`
annot_clean$`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` <-
  as.factor(annot_clean$`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)
annot_clean$`Corte FINAL vesícula` <- 
  as.numeric(annot_clean$`Corte FINAL vesícula`)
annot_clean$`Corte INICIAL vesícula` <- 
  as.numeric(annot_clean$`Corte INICIAL vesícula`)
annot_clean$`Densidade não habitual (sim=1, não=0)` <-
  as.numeric(annot_clean$`Densidade não habitual (sim=1, não=0)`)
annot_clean
```

### Criando Dataset

```{r, warning=FALSE}
path = "/home/luiz/Desktop/DATA-SET_TESTE/"
list.files(path) %>%  as_tibble() -> array_arquivos_dicom_tratados
separate(array_arquivos_dicom_tratados, col = value, sep = "_", into = c("PatientID","SerieNumber","InstanceNumber")) -> index_dicom
index_dicom$InstanceNumber %>% str_sub(end=-5) -> index_dicom$InstanceNumber
bind_cols(array_arquivos_dicom_tratados,index_dicom) -> index_dicom
names(index_dicom) <- c("FileName","PatientID","SerieNumber","InstanceNumber")
          index_dicom$PatientID <- as.numeric(index_dicom$PatientID)
          index_dicom$SerieNumber <- as.numeric(index_dicom$SerieNumber)
          index_dicom$InstanceNumber <- as.numeric(index_dicom$InstanceNumber)
          glimpse(index_dicom)
```

### Join das tabelas


```{r}
index_dicom %>% group_by(PatientID) %>% 
  left_join(annot_clean, by = c("PatientID" = "Patient ID")) %>% 
  ungroup() -> index_dicom
index_dicom$FilePath <- paste(path, index_dicom$FileName, sep='')
index_dicom %>% dplyr::select(1:9) -> base_tratada
base_tratada %>% dplyr::select(-5) -> base_tratada
base_tratada$FilePath <- paste(path, base_tratada$FileName, sep='')
base_tratada
```

### Extraindo e Comparando Tabelas

```{r}
#TABELA FREQUENCIA annot_clean
table(annot_clean$`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)

annot_clean %>% ggplot(aes(x = `Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)) + geom_bar(aes(fill = `Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)) + ylim(0, 105) + geom_text(stat = 'count', aes(label = ..count..), vjust=-0.5) + ggtitle("annot_clean") + ylab("contagem") + xlab(label ='') + theme(legend.position = "none")

#TABELA FREQUENCIA base_tratada
base_tratada %>% ggplot(aes(x = `Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)) + geom_bar(aes(fill = `Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`)) + ylim(0, 80000) + geom_text(stat = 'count', aes(label = ..count..), vjust=-0.5) + ggtitle("base_tratada") + ylab("contagem") + theme(legend.position = "none")


#N DE IMAGENS POR SERIENUMBER
base_tratada %>% group_by(PatientID) %>% count(SerieNumber) %>% ungroup(PatientID)




```

```{r echo=TRUE}
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("H","V"))), "imagens de", paste(base_tratada %>% filter(`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("H","V")) %>% count(PatientID) %>% nrow()), "pacientes que TEM vesícula")
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("S","C"))), "imagens de", paste(base_tratada %>% filter(`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("S","C")) %>% count(PatientID) %>% nrow()), "pacientes que NÃO TEM vesícula")
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("V"))), "Imagens Vesícula Normal")
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("H"))), "Imagens Vesícula Hipodistendida")
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("C"))), "Imagens Clipe Cirúrgico")
cat(nrow(filter(base_tratada,`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)` %in% c("S"))), "Imagens sem Vesícula/Clipe")
cat("Total de",nrow(base_tratada),"Imagens DICOM")
```

```{r}
#TABELA COM AS IMAGENS DA VESICULA
base_tratada %>% filter(`Hipodistendida/Vesícula normal/Clipe/sem clipe (HVSC)`== "V") %>% mutate(posicao_interesse = ifelse(c(InstanceNumber >= `Corte INICIAL vesícula` & InstanceNumber <= `Corte FINAL vesícula`), 1, 0)) %>% filter(posicao_interesse == 1) %>% select(-posicao_interesse) -> base_frames_vesicula_normal
nrow(base_frames_vesicula_normal)
```

